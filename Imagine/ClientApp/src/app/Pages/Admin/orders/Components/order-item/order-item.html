<!-- Order Item Card -->
<div class="order-card" (click)="openOrderDetails(orderDetailsModal)">
  <!-- Order Header -->
  <div class="order-header">
    <div class="order-info">
      <div class="order-number">{{ order.orderNumber }}</div>
      <div class="order-date">
        <i class="fas fa-calendar"></i>
        <span>{{ order.orderDate | date: 'medium' }}</span>
      </div>
    </div>
    
    <div class="order-status">
      <span class="status-badge" [ngClass]="order.status.toLowerCase()">
        <i class="fas fa-circle"></i>
        {{ order.status }}
      </span>
    </div>
  </div>
  
  <!-- Compact Order Summary (card view only) -->
  <div class="order-card-summary">
    <div class="order-card-total">
      <span class="order-card-total-label">Total</span>
      <span class="order-card-total-value">{{ order.totalAmount | currency:'EGP':'code' }}</span>
    </div>
  </div>

  <!-- Order Actions -->
  <div class="order-actions" (click)="$event.stopPropagation()">
    <button class="btn-action btn-view" title="View Details" (click)="openOrderDetails(orderDetailsModal); $event.stopPropagation()">
      <i class="fas fa-eye"></i>
      View Details
    </button>
    <button class="btn-action btn-update" title="Update Status" (click)="openStatusModal(statusModal); $event.stopPropagation()">
      <i class="fas fa-edit"></i>
      Update Status
    </button>
    <button class="btn-action btn-track" title="Track Package" (click)="openTrackingModal(trackingModal); $event.stopPropagation()">
      <i class="fas fa-map-marker-alt"></i>
      Track
    </button>
    <button class="btn-action btn-more" title="More Options">
      <i class="fas fa-ellipsis-v"></i>
    </button>
  </div>

  <!-- Order Details Modal Template -->
  <ng-template #orderDetailsModal let-modal>
    <div class="order-modal-wrapper">
      <div class="order-modal-header">
        <div class="order-modal-title-block">
          <div class="order-number">{{ displayedOrder.orderNumber }}</div>
          <div class="order-date">
            <i class="fas fa-calendar"></i>
            <span>{{ displayedOrder.orderDate | date: 'medium' }}</span>
          </div>
        </div>
        <div class="order-modal-status-block">
          <span class="status-badge" [ngClass]="displayedOrder.status.toLowerCase()">
            <i class="fas fa-circle"></i>
            {{ displayedOrder.status }}
          </span>
          <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
        </div>
      </div>

      <div class="order-modal-body">
        <div class="order-details-loading" *ngIf="detailsLoading">
          Loading order details...
        </div>
        <!-- Left: customer + timeline -->
        <div class="order-modal-main">
          <!-- Customer Info (reused) -->
          <div class="customer-section">
            <div class="customer-avatar">
              <img src= '/assets/images/hero-banner.png' alt="Customer">
              <div class="customer-badge vip">VIP</div>
            </div>
            <div class="customer-details">
              <div class="customer-label-row">
                <span class="customer-label">Customer</span>
              </div>
              <h4 class="customer-name">{{ displayedOrder.userName || 'Guest user' }}</h4>
              <div class="customer-contact-row">
                <div class="customer-contact-item">
                  <i class="fas fa-envelope"></i>
                  <span class="customer-email">{{ displayedOrder.userEmail || 'N/A' }}</span>
                </div>
                <div class="customer-contact-item">
                  <i class="fas fa-phone-alt"></i>
                  <span class="customer-phone">{{ displayedOrder.userPhoneNumber || 'N/A' }}</span>
                </div>
              </div>
            </div>
          </div>

          <!-- Timeline (reused) -->
          <div class="order-timeline">
            <!-- Order placed -->
            <div class="timeline-item completed">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <span class="timeline-label">Order Placed</span>
                <span class="timeline-time">
                  {{ displayedOrder.orderDate | date: 'medium' }}
                </span>
              </div>
            </div>

            <!-- Payment confirmed -->
            <div class="timeline-item" [ngClass]="paymentStatusLower === 'paid' ? 'completed' : 'pending'">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <span class="timeline-label">Payment Confirmed</span>
                <span class="timeline-time">
                  {{ paymentStatusLower === 'paid' && displayedOrder.paidAt ? (displayedOrder.paidAt | date: 'medium') : 'Pending' }}
                </span>
              </div>
            </div>

            <!-- Processing -->
            <div class="timeline-item"
                 [ngClass]="statusLower === 'processing' || statusLower === 'pending' ? 'active' : (statusLower === 'shipped' || statusLower === 'delivered' ? 'completed' : 'pending')">
              <div class="timeline-dot">
                <i class="fas fa-cog fa-spin" *ngIf="statusLower === 'processing' || statusLower === 'pending'"></i>
              </div>
              <div class="timeline-content">
                <span class="timeline-label">Processing</span>
                <span class="timeline-time">
                  {{ statusLower === 'shipped' || statusLower === 'delivered' ? 'Completed' : 'In Progress' }}
                </span>
              </div>
            </div>

            <!-- Shipped -->
            <div class="timeline-item" [ngClass]="displayedOrder.shippedAt || statusLower === 'shipped' || statusLower === 'delivered' ? 'completed' : 'pending'">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <span class="timeline-label">Shipped</span>
                <span class="timeline-time">
                  {{ displayedOrder.shippedAt ? (displayedOrder.shippedAt | date: 'medium') : 'Pending' }}
                </span>
              </div>
            </div>

            <!-- Delivered -->
            <div class="timeline-item" [ngClass]="displayedOrder.deliveredAt || statusLower === 'delivered' ? 'completed' : 'pending'">
              <div class="timeline-dot"></div>
              <div class="timeline-content">
                <span class="timeline-label">Delivered</span>
                <span class="timeline-time">
                  {{ displayedOrder.deliveredAt ? (displayedOrder.deliveredAt | date: 'medium') : 'Pending' }}
                </span>
              </div>
            </div>
          </div>
        </div>

        <!-- Right: items + summary + shipping -->
        <div class="order-modal-side">
          <!-- Items (reused) -->
          <div class="order-items">
            <div class="items-header">
              <h5>Order Items ({{ displayedOrder.items.length }})</h5>
            </div>
            <div class="items-list">
              <div class="item-card standard" *ngFor="let item of displayedOrder.items">
                <div class="item-image">
                  <img [src]="item.productImageUrl || '/assets/images/product-placeholder.jpg'" [alt]="item.productName">
                </div>
                <div class="item-details">
                  <div class="item-header">
                    <span class="item-badge standard">Standard</span>
                    <h6 class="item-name">{{ item.productName }}</h6>
                  </div>
                  <div class="item-specs">
                    <span class="item-color" *ngIf="item.colorName">
                      <div class="color-dot"></div>
                      {{ item.colorName }}
                    </span>
                    <span class="item-quantity">Qty: {{ item.quantity }}</span>
                  </div>
                  <div class="item-pricing">
                    <span class="item-price-label">Unit</span>
                    <span class="item-price">{{ item.unitPrice | currency:'EGP':'code' }}</span>
                    <span class="item-multiply">Ã— {{ item.quantity }}</span>
                    <span class="item-line-total">{{ item.totalPrice | currency:'EGP':'code' }}</span>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <!-- Summary + payment (reused) -->
          <div class="order-summary">
            <div class="summary-section">
              <div class="summary-row">
                <span class="summary-label">Subtotal:</span>
                <span class="summary-value">{{ displayedOrder.subTotal | currency:'EGP':'code' }}</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Shipping:</span>
                <span class="summary-value">{{ displayedOrder.shippingCost | currency:'EGP':'code' }}</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Tax:</span>
                <span class="summary-value">{{ displayedOrder.tax | currency:'EGP':'code' }}</span>
              </div>
              <div class="summary-row total">
                <span class="summary-label">Total:</span>
                <span class="summary-value">{{ displayedOrder.totalAmount | currency:'EGP':'code' }}</span>
              </div>
            </div>

            <div class="payment-info">
              <div class="payment-method">
                <i class="fab fa-cc-visa"></i>
                <span>{{ displayedOrder.paymentMethod || 'N/A' }}</span>
                <span class="payment-status" [ngClass]="displayedOrder.paymentStatus.toLowerCase()">
                  {{ displayedOrder.paymentStatus }}
                </span>
              </div>
            </div>
          </div>

          <!-- Shipping (reused) -->
          <div class="shipping-section">
            <h6 class="section-title">
              <i class="fas fa-shipping-fast"></i>
              Shipping Address
            </h6>
            <div class="shipping-address">
              <div class="address-line">{{ displayedOrder.shippingAddress }}</div>
              <div class="address-line">{{ displayedOrder.shippingCity }}, {{ displayedOrder.shippingPostalCode }}</div>
              <div class="address-line">{{ displayedOrder.shippingCountry }}</div>
            </div>
            <div class="tracking-info">
              <div class="tracking-number">
                <i class="fas fa-barcode"></i>
                <span>Tracking: {{ displayedOrder.trackingNumber || 'N/A' }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </ng-template>

  <!-- Update Status Modal -->
  <ng-template #statusModal let-modal>
    <div class="order-status-modal">
      <div class="order-status-header">
        <h5>Update Order Status</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
      </div>
      <div class="order-status-body">
        <div class="status-steps">
          <button type="button" class="status-step" [ngClass]="{ 'active': selectedStatus === 'Pending' }" (click)="setStatus('Pending')">
            <span class="step-label">Pending</span>
          </button>
          <button type="button" class="status-step" [ngClass]="{ 'active': selectedStatus === 'Processing' }" (click)="setStatus('Processing')">
            <span class="step-label">Processing</span>
          </button>
          <button type="button" class="status-step" [ngClass]="{ 'active': selectedStatus === 'Shipped' }" (click)="setStatus('Shipped')">
            <span class="step-label">Shipped</span>
          </button>
          <button type="button" class="status-step" [ngClass]="{ 'active': selectedStatus === 'Delivered' }" (click)="setStatus('Delivered')">
            <span class="step-label">Delivered</span>
          </button>
          <button type="button" class="status-step alt" [ngClass]="{ 'active': selectedStatus === 'Cancelled' }" (click)="setStatus('Cancelled')">
            <span class="step-label">Cancelled</span>
          </button>
        </div>

        <div class="status-form">
          <div class="form-group">
            <label>Tracking Number (optional)</label>
            <input
              type="text"
              class="form-control form-control-sm"
              placeholder="Add or update tracking number"
              [(ngModel)]="trackingNumberInput"
              name="trackingNumber" />
          </div>
          <div class="form-group">
            <label>Admin Notes</label>
            <textarea
              class="form-control form-control-sm"
              rows="3"
              placeholder="Add internal notes about this status change"
              [(ngModel)]="statusNotes"
              name="statusNotes"></textarea>
          </div>
        </div>
      </div>
      <div class="order-status-footer">
        <button type="button" class="btn btn-outline-light btn-sm" (click)="modal.dismiss()">Cancel</button>
        <button type="button" class="btn btn-primary btn-sm" (click)="saveStatus(modal)">Save Status</button>
      </div>
    </div>
  </ng-template>

  <!-- Tracking Modal -->
  <ng-template #trackingModal let-modal>
    <div class="order-tracking-modal">
      <div class="order-status-header">
        <h5>Tracking Information</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
      </div>
      <div class="order-status-body">
        <div class="tracking-summary">
          <div class="tracking-number-row">
            <span class="label">Tracking:</span>
            <span class="value">{{ order.trackingNumber || 'N/A' }}</span>
          </div>
          <div class="tracking-number-row">
            <span class="label">Carrier:</span>
            <span class="value">N/A</span>
          </div>
        </div>
        <div class="tracking-progress">
          <div class="progress-label-row">
            <span>{{ trackingLabel }}</span>
            <span>{{ trackingPercent }}%</span>
          </div>
          <div class="progress">
            <div class="progress-bar" role="progressbar" [style.width.%]="trackingPercent"></div>
          </div>
        </div>
      </div>
      <div class="order-status-footer">
        <button type="button" class="btn btn-outline-light btn-sm" (click)="modal.dismiss()">Close</button>
      </div>
    </div>
  </ng-template>

  <!-- Custom Product Preview Modal -->
  <ng-template #customPreviewModal let-modal>
    <div class="custom-preview-modal">
      <div class="order-status-header">
        <h5>Custom Product Preview</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="modal.dismiss()"></button>
      </div>
      <div class="custom-preview-body">
        <div class="preview-columns">
          <div class="preview-panel">
            <div class="panel-label">User Design Upload</div>
            <div class="preview-box user-design">
              <span>Customer Uploaded Design</span>
            </div>
          </div>
          <div class="preview-panel">
            <div class="panel-label">AI Rendered Preview</div>
            <div class="preview-box ai-preview">
              <span>AI Rendered Hoodie Preview</span>
            </div>
          </div>
        </div>
        <div class="preview-colors">
          <div class="panel-label">Chosen Colors</div>
          <div class="color-chips">
            <div class="color-chip" style="background: #2196F3"></div>
            <div class="color-chip" style="background: #111827"></div>
            <div class="color-chip" style="background: #FFFFFF"></div>
          </div>
        </div>
      </div>
      <div class="order-status-footer">
        <button type="button" class="btn btn-outline-light btn-sm" (click)="modal.dismiss()">Close</button>
      </div>
    </div>
  </ng-template>
</div>

